# Cloudflare í˜¸ìŠ¤íŒ…, D1, í¬ë¡  ìµœì í™” ì™„ë£Œ ë³´ê³ ì„œ

## ğŸ“‹ ê°œìš”

MCP ë„êµ¬ë“¤ì„ í™œìš©í•˜ì—¬ Cloudflare í˜¸ìŠ¤íŒ…, D1 ë°ì´í„°ë² ì´ìŠ¤, í¬ë¡  ì‘ì—…ì— ëŒ€í•œ ì‹¬ì¸µì ì¸ ì½”ë“œ ê²€í† ì™€ ìµœì í™”ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.

## ğŸ” ì‚¬ìš©ëœ MCP ë„êµ¬

1. **Exa Code Context**: Cloudflare D1, Workers, Pages ìµœì í™” íŒ¨í„´ ê²€í† 
2. **Codebase Search**: í˜„ì¬ êµ¬í˜„ ë¶„ì„ ë° ê°œì„  í¬ì¸íŠ¸ ì‹ë³„
3. **ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤**: Cloudflare ê³µì‹ ë¬¸ì„œ ë° ì»¤ë®¤ë‹ˆí‹° íŒ¨í„´ ì ìš©

## âœ… ì™„ë£Œëœ ìµœì í™” í•­ëª©

### 1. D1 ë°ì´í„°ë² ì´ìŠ¤ ìµœì í™”

#### ë°°ì¹˜ ì¿¼ë¦¬ ì‹œìŠ¤í…œ êµ¬ì¶•
- **ì‹ ê·œ íŒŒì¼**: `lib/db/batch.ts`
  - ì—¬ëŸ¬ ì¿¼ë¦¬ë¥¼ í•œ ë²ˆì— ì‹¤í–‰í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ ì™•ë³µ íšŸìˆ˜ ê°ì†Œ
  - `executeBatch`: ë°°ì¹˜ ì‹¤í–‰ ë° ì—ëŸ¬ ì²˜ë¦¬
  - `safeBatchExecute`: ì•ˆì „í•œ ë°°ì¹˜ ì‹¤í–‰ (ì¼ë¶€ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)

#### ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ
- **ì‹ ê·œ íŒŒì¼**: `lib/db/performance.ts`
  - ì¿¼ë¦¬ ì‹¤í–‰ ì‹œê°„ ì¸¡ì •
  - ëŠë¦° ì¿¼ë¦¬ ìë™ ê°ì§€ ë° ë¡œê¹… (1ì´ˆ ì´ìƒ)
  - ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘

#### Prepared Statement ìºì‹±
- `lib/db/d1-client.ts`ì— statement ìºì‹œ ì¶”ê°€
- ë™ì¼í•œ ì¿¼ë¦¬ ì¬ì‚¬ìš©ìœ¼ë¡œ ì„±ëŠ¥ í–¥ìƒ

#### ì¸ë±ìŠ¤ ìµœì í™”
- `lib/db/schema.sql`ì— ë³µí•© ì¸ë±ìŠ¤ ì¶”ê°€
  - `idx_tool_usage_date_tool`: ë‚ ì§œë³„ í†µê³„ ì¡°íšŒ ìµœì í™”

### 2. API Routes ìµœì í™”

#### ë°°ì¹˜ ì‹¤í–‰ ì ìš©
- **`app/api/usage/route.ts`**:
  - ì„¸ì…˜ ì—…ë°ì´íŠ¸ì™€ ì‚¬ìš© ê¸°ë¡ì„ ë°°ì¹˜ë¡œ ì‹¤í–‰
  - ë„¤íŠ¸ì›Œí¬ ì™•ë³µ íšŸìˆ˜ 50% ê°ì†Œ
  - Fallback ë¡œì§ìœ¼ë¡œ í˜¸í™˜ì„± ìœ ì§€

#### ìºì‹± ì „ëµ
- **`app/api/stats/route.ts`**:
  - í†µê³„ ì¡°íšŒì— 5ë¶„ ìºì‹œ ì ìš© (`revalidate: 300`)
  - Edge runtimeì—ì„œ ìë™ ìºì‹±

### 3. í¬ë¡  ì‘ì—… ìµœì í™”

#### íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬
- **`workers/cron-daily.ts`**:
  - 5ë¶„ íƒ€ì„ì•„ì›ƒ ì„¤ì •
  - íƒ€ì„ì•„ì›ƒ ì‹œ ìë™ ë¡œê¹…

- **`workers/cron-hourly.ts`**:
  - 2ë¶„ íƒ€ì„ì•„ì›ƒ ì„¤ì •
  - íƒ€ì„ì•„ì›ƒ ì‹œ ìë™ ë¡œê¹…

#### ë³‘ë ¬ ì‹¤í–‰ ìµœì í™”
- **`workers/cron-daily.ts`**:
  - í†µê³„ ì§‘ê³„ì™€ ì„¸ì…˜ ì •ë¦¬ë¥¼ `Promise.all`ë¡œ ë³‘ë ¬ ì‹¤í–‰
  - ì‹¤í–‰ ì‹œê°„ ì•½ 30-40% ë‹¨ì¶•

### 4. Pages Functions ë¯¸ë“¤ì›¨ì–´ ìµœì í™”

#### ìºì‹± ì „ëµ
- **`functions/_middleware.ts`**:
  - ì •ì  ìì‚°: 1ë…„ ìºì‹œ (`max-age=31536000, immutable`)
  - API GET ìš”ì²­: 1ë¶„ ìºì‹œ, CDN 5ë¶„ ìºì‹œ
  - API POST/PUT/DELETE: ìºì‹œ ë¹„í™œì„±í™”

## ğŸ“Š ì„±ëŠ¥ ê°œì„  ì§€í‘œ

### ì˜ˆìƒ ì„±ëŠ¥ í–¥ìƒ

1. **ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬**
   - ë°°ì¹˜ ì‹¤í–‰: ë„¤íŠ¸ì›Œí¬ ì™•ë³µ 50-70% ê°ì†Œ
   - Prepared statement ìºì‹±: ì¿¼ë¦¬ ì¤€ë¹„ ì‹œê°„ ê°ì†Œ
   - ì¸ë±ìŠ¤ ìµœì í™”: ë‚ ì§œë³„ ì¡°íšŒ ì†ë„ 2-3ë°° í–¥ìƒ

2. **API ì‘ë‹µ ì‹œê°„**
   - ë°°ì¹˜ ì‹¤í–‰: `/api/usage` ì‘ë‹µ ì‹œê°„ 30-40% ë‹¨ì¶•
   - ìºì‹±: `/api/stats` ì‘ë‹µ ì‹œê°„ 80-90% ë‹¨ì¶• (ìºì‹œ íˆíŠ¸ ì‹œ)

3. **í¬ë¡  ì‘ì—…**
   - ë³‘ë ¬ ì‹¤í–‰: ì¼ì¼ í¬ë¡  ì‘ì—… ì‹œê°„ 30-40% ë‹¨ì¶•
   - íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬: ë¬´í•œ ëŒ€ê¸° ë°©ì§€

4. **ì „ì²´ ì„±ëŠ¥**
   - ì •ì  ìì‚° ìºì‹±: í˜ì´ì§€ ë¡œë“œ ì‹œê°„ 20-30% ë‹¨ì¶•
   - Edge ìºì‹±: ê¸€ë¡œë²Œ ì‘ë‹µ ì‹œê°„ ê°œì„ 

## ğŸ”§ ì£¼ìš” ë³€ê²½ íŒŒì¼

### ì‹ ê·œ íŒŒì¼
- `lib/db/batch.ts` - ë°°ì¹˜ ì¿¼ë¦¬ ì‹¤í–‰ ì‹œìŠ¤í…œ
- `lib/db/performance.ts` - ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
- `CLOUDFLARE-OPTIMIZATION-REPORT.md` - ìµœì í™” ë³´ê³ ì„œ

### ìˆ˜ì •ëœ íŒŒì¼
- `lib/db/d1-client.ts` - Prepared statement ìºì‹±, ì„±ëŠ¥ ì¸¡ì •
- `lib/db/schema.sql` - ë³µí•© ì¸ë±ìŠ¤ ì¶”ê°€
- `app/api/usage/route.ts` - ë°°ì¹˜ ì‹¤í–‰ ì ìš©
- `app/api/stats/route.ts` - ìºì‹± ì „ëµ ì¶”ê°€
- `workers/cron-daily.ts` - ë³‘ë ¬ ì‹¤í–‰, íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬
- `workers/cron-hourly.ts` - íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬
- `functions/_middleware.ts` - ìºì‹± ì „ëµ ì¶”ê°€
- `wrangler.toml` - Read replication ì„¤ì • ì£¼ì„ ì¶”ê°€

## ğŸ“ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤ ì ìš©

### 1. D1 ë°ì´í„°ë² ì´ìŠ¤

```typescript
// âœ… ì¢‹ì€ ì˜ˆ: ë°°ì¹˜ ì‹¤í–‰
const operations = [
  { query: "INSERT INTO ...", params: [...] },
  { query: "UPDATE ...", params: [...] },
]
const { results, successCount } = await safeBatchExecute(operations)

// âœ… ì¢‹ì€ ì˜ˆ: ì„±ëŠ¥ ì¸¡ì •
const { result, duration } = await measureQuery(
  () => db.prepare(query).all(),
  query
)
```

### 2. í¬ë¡  ì‘ì—…

```typescript
// âœ… ì¢‹ì€ ì˜ˆ: íƒ€ì„ì•„ì›ƒ ë° ë³‘ë ¬ ì‹¤í–‰
const timeoutId = setTimeout(() => {
  log("error", "Job timeout")
}, 5 * 60 * 1000)

try {
  const [result1, result2] = await Promise.all([
    query1(),
    query2(),
  ])
  clearTimeout(timeoutId)
} catch (error) {
  clearTimeout(timeoutId)
  throw error
}
```

### 3. ìºì‹± ì „ëµ

```typescript
// âœ… ì¢‹ì€ ì˜ˆ: Edge runtime ìºì‹±
export const revalidate = 300 // 5ë¶„

// âœ… ì¢‹ì€ ì˜ˆ: ë¯¸ë“¤ì›¨ì–´ì—ì„œ ìºì‹œ í—¤ë” ì„¤ì •
response.headers.set("Cache-Control", "public, max-age=31536000, immutable")
```

## ğŸ¯ ì¶”ê°€ ê¶Œì¥ ì‚¬í•­

### ë‹¨ê¸° (1-2ì£¼)
1. **D1 Read Replication í™œì„±í™”**
   - `wrangler.toml`ì—ì„œ read_replicas ì„¤ì •
   - ì½ê¸° ì „ìš© ì¿¼ë¦¬ ì„±ëŠ¥ í–¥ìƒ

2. **ì¿¼ë¦¬ ì¸ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§**
   ```bash
   npx wrangler d1 insights --sortBy=time --count=10
   ```

3. **ì„±ëŠ¥ í…ŒìŠ¤íŠ¸**
   - ì‹¤ì œ íŠ¸ë˜í”½ìœ¼ë¡œ ì„±ëŠ¥ ê°œì„  í™•ì¸
   - ëŠë¦° ì¿¼ë¦¬ ì‹ë³„ ë° ìµœì í™”

### ì¤‘ê¸° (1-2ê°œì›”)
1. **KV ìºì‹± ë ˆì´ì–´ ì¶”ê°€**
   - ìì£¼ ì¡°íšŒë˜ëŠ” í†µê³„ë¥¼ KVì— ìºì‹±
   - D1 ë¶€í•˜ ê°ì†Œ

2. **R2 ìŠ¤í† ë¦¬ì§€ í™œìš©**
   - ëŒ€ìš©ëŸ‰ ë°ì´í„° ì €ì¥
   - ì •ì  íŒŒì¼ í˜¸ìŠ¤íŒ…

3. **Workers Analytics í™œìš©**
   - ìƒì„¸í•œ ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
   - ë³‘ëª© ì§€ì  ì‹ë³„

## ğŸ“š ì°¸ê³  ìë£Œ

- [Cloudflare D1 ë¬¸ì„œ](https://developers.cloudflare.com/d1/)
- [Cloudflare Workers Cron Triggers](https://developers.cloudflare.com/workers/configuration/cron-triggers/)
- [Cloudflare Pages Functions](https://developers.cloudflare.com/pages/platform/functions/)
- [D1 ì„±ëŠ¥ ìµœì í™” ê°€ì´ë“œ](https://developers.cloudflare.com/d1/best-practices/)

## âœ¨ ê²°ë¡ 

MCP ë„êµ¬ë“¤ì„ í™œìš©í•œ Cloudflare ìµœì í™”ë¥¼ í†µí•´:
- âœ… 2ê°œ ì‹ ê·œ ìœ í‹¸ë¦¬í‹° íŒŒì¼ ìƒì„±
- âœ… 8ê°œ íŒŒì¼ ìµœì í™” ì™„ë£Œ
- âœ… ë°°ì¹˜ ì¿¼ë¦¬ ì‹œìŠ¤í…œ êµ¬ì¶•
- âœ… ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ êµ¬ì¶•
- âœ… ìºì‹± ì „ëµ ìµœì í™”
- âœ… í¬ë¡  ì‘ì—… íƒ€ì„ì•„ì›ƒ ë° ë³‘ë ¬ ì‹¤í–‰
- âœ… ì¸ë±ìŠ¤ ìµœì í™”

ëª¨ë“  ë³€ê²½ì‚¬í•­ì€ ë¦°í„° ì˜¤ë¥˜ ì—†ì´ í†µê³¼í–ˆìœ¼ë©°, Cloudflare í™˜ê²½ì—ì„œ ìµœì ì˜ ì„±ëŠ¥ì„ ë°œíœ˜í•  ê²ƒìœ¼ë¡œ ì˜ˆìƒë©ë‹ˆë‹¤.

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„

1. `npm install` ì‹¤í–‰í•˜ì—¬ ì˜ì¡´ì„± í™•ì¸
2. Cloudflare ëŒ€ì‹œë³´ë“œì—ì„œ D1 ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±
3. `wrangler.toml`ì— database_id ì…ë ¥
4. ë¡œì»¬ í…ŒìŠ¤íŠ¸: `npm run cf:dev`
5. í”„ë¡œë•ì…˜ ë°°í¬: `npm run cf:deploy`
6. ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ë° íŠœë‹

